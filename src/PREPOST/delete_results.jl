# FILE: delete_results.jl
# ──────────────────────────────────────────────────────────────────────────────
# Deletes LUDWIG LBM solver output files from CASES/*/RESULTS/ directories.
#
# Targets ONLY files matching LUDWIG output naming patterns:
#
#   ── Per-timestep outputs (large, regenerable) ──
#   flow_XXXXXX.vtu          Flow field VTK
#   surface_XXXXXX.vtu       Surface pressure/stress VTK
#   surface_XXXXXX.lbmp      Surface pressure binary (web viewer)
#   net_forces_XXXXXX.csv    Per-triangle net forces
#   net_forces_XXXXXX.vtp    Per-triangle net forces VTK
#
#   ── Single-file outputs ──
#   convergence.csv          Convergence history
#   forces.csv               Aerodynamic forces history
#   Analysis_summary.md      Per-case analysis report
#
#   ── Batch summary (in project root) ──
#   cases_summary_*.md       Multi-case summary tables
#
# Files NOT deleted (safe):
#   config.yaml, *.stl, *.jl, *.html, *.yaml, *.toml, nodal_loads*.csv,
#   Nodal_loads_summary.md, and anything not matching the patterns above.
#
# Usage:
#   julia src/PREPOST/delete_results.jl              # dry-run (default)
#   julia src/PREPOST/delete_results.jl --delete      # actually delete files
#   julia src/PREPOST/delete_results.jl --delete path  # custom root directory
# ──────────────────────────────────────────────────────────────────────────────

using Printf

# ── LUDWIG output file patterns ──
# These regex patterns match ONLY files generated by the solver.
const TIMESTEP_PATTERNS = [
    r"^flow_\d{6}\.vtu$",              # flow field VTK
    r"^surface_\d{6}\.vtu$",           # surface pressure VTK  (also matches .vtp internally)
    r"^surface_\d{6}\.vtp$",           # surface pressure VTK PolyData
    r"^surface_\d{6}\.lbmp$",          # surface pressure binary
    r"^net_forces_\d{6}\.csv$",        # net triangle forces CSV
    r"^net_forces_\d{6}\.vtp$",        # net triangle forces VTK PolyData
]

const SINGLE_FILE_PATTERNS = [
    r"^convergence\.csv$",             # convergence history
    r"^forces\.csv$",                  # aerodynamic forces
    r"^Analysis_summary\.md$",         # per-case analysis report
]

const ROOT_PATTERNS = [
    r"^cases_summary_\d{8}_\d{6}\.md$",  # batch summary: cases_summary_YYYYMMDD_HHMMSS.md
]

"""
Check if a filename matches any LUDWIG output pattern.
Returns (true/false, pattern_description).
"""
function matches_ludwig_output(filename::String)
    for pat in TIMESTEP_PATTERNS
        if occursin(pat, filename)
            return true, "timestep output"
        end
    end
    for pat in SINGLE_FILE_PATTERNS
        if occursin(pat, filename)
            return true, "single-file output"
        end
    end
    return false, ""
end

function matches_root_pattern(filename::String)
    for pat in ROOT_PATTERNS
        if occursin(pat, filename)
            return true, "batch summary"
        end
    end
    return false, ""
end

function delete_results(root_dir::String="."; actually_delete::Bool=false)
    files_found   = String[]
    files_deleted = String[]
    files_failed  = String[]
    total_bytes   = 0

    mode_str = actually_delete ? "DELETE" : "DRY-RUN"
    println("="^70)
    println("  LUDWIG Results Cleanup — $mode_str")
    println("="^70)
    println("[Cleanup] Root directory: $(abspath(root_dir))")
    println()

    # ── 1. Scan CASES/*/RESULTS/ directories ──
    cases_dir = joinpath(root_dir, "CASES")
    if isdir(cases_dir)
        for case_name in sort(readdir(cases_dir))
            results_dir = joinpath(cases_dir, case_name, "RESULTS")
            if !isdir(results_dir)
                continue
            end

            case_files = String[]
            case_bytes = 0

            for fname in sort(readdir(results_dir))
                is_match, category = matches_ludwig_output(fname)
                if is_match
                    fpath = joinpath(results_dir, fname)
                    if isfile(fpath)
                        fsize = filesize(fpath)
                        push!(case_files, fpath)
                        push!(files_found, fpath)
                        case_bytes += fsize
                        total_bytes += fsize
                    end
                end
            end

            if !isempty(case_files)
                @printf("[Cleanup] %-30s  %3d files  %8.1f MB\n",
                        case_name, length(case_files), case_bytes / 1e6)

                if actually_delete
                    for fpath in case_files
                        try
                            rm(fpath)
                            push!(files_deleted, fpath)
                        catch e
                            println("  [Error] Failed to delete: $fpath — $e")
                            push!(files_failed, fpath)
                        end
                    end
                end
            end
        end
    else
        println("[Cleanup] No CASES/ directory found in $(abspath(root_dir))")
    end

    # ── 2. Scan root directory for batch summaries ──
    root_files = String[]
    for fname in readdir(root_dir)
        is_match, category = matches_root_pattern(fname)
        if is_match
            fpath = joinpath(root_dir, fname)
            if isfile(fpath)
                fsize = filesize(fpath)
                push!(root_files, fpath)
                push!(files_found, fpath)
                total_bytes += fsize
            end
        end
    end

    if !isempty(root_files)
        root_bytes = sum(filesize, root_files)
        @printf("[Cleanup] %-30s  %3d files  %8.1f MB\n",
                "(project root)", length(root_files), root_bytes / 1e6)

        if actually_delete
            for fpath in root_files
                try
                    rm(fpath)
                    push!(files_deleted, fpath)
                catch e
                    println("  [Error] Failed to delete: $fpath — $e")
                    push!(files_failed, fpath)
                end
            end
        end
    end

    # ── 3. Summary ──
    println()
    println("-"^70)
    @printf("[Cleanup] Total files found:    %d\n", length(files_found))
    @printf("[Cleanup] Total size:           %.1f MB\n", total_bytes / 1e6)

    if actually_delete
        @printf("[Cleanup] Files deleted:        %d\n", length(files_deleted))
        if !isempty(files_failed)
            @printf("[Cleanup] Files FAILED:         %d\n", length(files_failed))
        end
        println("[Cleanup] Cleanup complete.")
    else
        println()
        println("[Cleanup] *** DRY-RUN — no files were deleted ***")
        println("[Cleanup] To actually delete, run with --delete flag:")
        println("[Cleanup]   julia src/PREPOST/delete_results.jl --delete")
    end
    println("-"^70)

    return length(files_found), length(files_deleted), total_bytes
end

# ── Entry point ──
function main()
    actually_delete = false
    root_dir = "."

    for arg in ARGS
        if arg == "--delete"
            actually_delete = true
        elseif arg == "--help" || arg == "-h"
            println("""
            LUDWIG Results Cleanup Tool

            Deletes solver output files (VTK, CSV, LBMP, MD) from CASES/*/RESULTS/
            directories. Only files matching LUDWIG naming patterns are targeted.

            Usage:
              julia src/PREPOST/delete_results.jl              # dry-run (show what would be deleted)
              julia src/PREPOST/delete_results.jl --delete      # actually delete files
              julia src/PREPOST/delete_results.jl --delete path # custom root directory

            File patterns deleted:
              flow_XXXXXX.vtu        surface_XXXXXX.vtu      surface_XXXXXX.lbmp
              net_forces_XXXXXX.csv  net_forces_XXXXXX.vtp   convergence.csv
              forces.csv             Analysis_summary.md      cases_summary_*.md
            """)
            return
        else
            root_dir = arg
        end
    end

    delete_results(root_dir; actually_delete=actually_delete)
end

main()
